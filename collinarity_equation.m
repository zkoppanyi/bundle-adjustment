% Jacobian
syms X X0 Y Y0 Z Z0 f f x y cx cy phi kappa omega

% R11 = cos(phi)*cos(kappa);
% R12 = -cos(phi)*sin(kappa);
% R13 = sin(phi);
% R21 = cos(omega)*sin(kappa)+sin(omega)*sin(phi)*cos(kappa);
% R22 = cos(omega)*cos(kappa)-sin(omega)*sin(phi)*sin(kappa);
% R23 = -sin(omega)*cos(phi);
% R31 = sin(omega)*sin(kappa)-cos(omega)*sin(phi)*cos(kappa);
% R32 = sin(omega)*cos(kappa)+cos(omega)*sin(phi)*sin(kappa);
% R33 = cos(omega)*cos(phi);
% 
% x = -f * (R11*(X-X0) + R12*(Y-Y0) + R13*(Z-Z0)) / (R31*(X-X0) + R32*(Y-Y0) + R33*(Z-Z0)) + cx;
% y = -f * (R21*(X-X0) + R22*(Y-Y0) + R23*(Z-Z0)) / (R31*(X-X0) + R32*(Y-Y0) + R33*(Z-Z0)) + cy;
% 
% row = [diff(x, X0), diff(x, Y0), diff(x, Z0), diff(x, omega), diff(x, phi), diff(x, kappa);
%        diff(y, X0), diff(y, Y0), diff(y, Z0), diff(y, omega), diff(y, phi), diff(y, kappa)]
% 
% %% Equations
% 
% % Rotation matrix
R11 = @(omega,phi,kappa) cos(phi).*cos(kappa);
R12 = @(omega,phi,kappa) -cos(phi).*sin(kappa);
R13 = @(omega,phi,kappa) sin(phi);
R21 = @(omega,phi,kappa) cos(omega).*sin(kappa)+sin(omega).*sin(phi).*cos(kappa);
R22 = @(omega,phi,kappa) cos(omega).*cos(kappa)-sin(omega).*sin(phi).*sin(kappa);
R23 = @(omega,phi,kappa) -sin(omega).*cos(phi);
R31 = @(omega,phi,kappa) sin(omega).*sin(kappa)-cos(omega).*sin(phi).*cos(kappa);
R32 = @(omega,phi,kappa) sin(omega).*cos(kappa)+cos(omega).*sin(phi).*sin(kappa);
R33 = @(omega,phi,kappa) cos(omega).*cos(phi);

% % Collinarity equation
% xc = @(c, x0, y0, X0, Y0, Z0, omega, phi, kappa, X, Y, Z) - c * (R11(omega,phi,kappa).*(X-X0) + R12(omega,phi,kappa).*(Y-Y0) + R13(omega,phi,kappa).*(Z-Z0)) ./ (R31(omega,phi,kappa).*(X-X0) + R32(omega,phi,kappa).*(Y-Y0) + R33(omega,phi,kappa).*(Z-Z0)) + x0;
% yc = @(c, x0, y0, X0, Y0, Z0, omega, phi, kappa, X, Y, Z) - c * (R21(omega,phi,kappa).*(X-X0) + R22(omega,phi,kappa).*(Y-Y0) + R23(omega,phi,kappa).*(Z-Z0)) ./ (R31(omega,phi,kappa).*(X-X0) + R32(omega,phi,kappa).*(Y-Y0) + R33(omega,phi,kappa).*(Z-Z0)) + y0;
% 
% % Design matrix
% Arow = @(c, x0, y0, X0, Y0, Z0, omega, phi, kappa, X, Y, Z) ...
% [                                                                                                                           (c*cos(kappa)*cos(phi))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) - (c*(sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(sin(phi)*(Z - Z0) + cos(kappa)*cos(phi)*(X - X0) - cos(phi)*sin(kappa)*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2,                                                                                                                         - (c*cos(phi)*sin(kappa))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) - (c*(cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(sin(phi)*(Z - Z0) + cos(kappa)*cos(phi)*(X - X0) - cos(phi)*sin(kappa)*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2,                                                                                                   (c*sin(phi))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) - (c*cos(omega)*cos(phi)*(sin(phi)*(Z - Z0) + cos(kappa)*cos(phi)*(X - X0) - cos(phi)*sin(kappa)*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2, (c*(sin(phi)*(Z - Z0) + cos(kappa)*cos(phi)*(X - X0) - cos(phi)*sin(kappa)*(Y - Y0))*((cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi))*(X - X0) + (cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi))*(Y - Y0) - cos(phi)*sin(omega)*(Z - Z0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2,                                                                                                                       - (c*(cos(phi)*(Z - Z0) - cos(kappa)*sin(phi)*(X - X0) + sin(kappa)*sin(phi)*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) - (c*(sin(phi)*(Z - Z0) + cos(kappa)*cos(phi)*(X - X0) - cos(phi)*sin(kappa)*(Y - Y0))*(cos(omega)*sin(phi)*(Z - Z0) + cos(kappa)*cos(omega)*cos(phi)*(X - X0) - cos(omega)*cos(phi)*sin(kappa)*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2,                                                                                                                                                                (c*(cos(kappa)*cos(phi)*(Y - Y0) + cos(phi)*sin(kappa)*(X - X0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) + (c*((cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(X - X0) - (sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(Y - Y0))*(sin(phi)*(Z - Z0) + cos(kappa)*cos(phi)*(X - X0) - cos(phi)*sin(kappa)*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2;
%     (c*(cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) - (c*(sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*((cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi))*(X - X0) + (cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi))*(Y - Y0) - cos(phi)*sin(omega)*(Z - Z0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2, (c*(cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) - (c*(cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*((cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi))*(X - X0) + (cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi))*(Y - Y0) - cos(phi)*sin(omega)*(Z - Z0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2, - (c*cos(phi)*sin(omega))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) - (c*cos(omega)*cos(phi)*((cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi))*(X - X0) + (cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi))*(Y - Y0) - cos(phi)*sin(omega)*(Z - Z0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2,                                                                             c + (c*((cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi))*(X - X0) + (cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi))*(Y - Y0) - cos(phi)*sin(omega)*(Z - Z0))^2)/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2, - (c*(sin(omega)*sin(phi)*(Z - Z0) + cos(kappa)*cos(phi)*sin(omega)*(X - X0) - cos(phi)*sin(kappa)*sin(omega)*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0)) - (c*((cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi))*(X - X0) + (cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi))*(Y - Y0) - cos(phi)*sin(omega)*(Z - Z0))*(cos(omega)*sin(phi)*(Z - Z0) + cos(kappa)*cos(omega)*cos(phi)*(X - X0) - cos(omega)*cos(phi)*sin(kappa)*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2, (c*((cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(X - X0) - (sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(Y - Y0))*((cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi))*(X - X0) + (cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi))*(Y - Y0) - cos(phi)*sin(omega)*(Z - Z0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))^2 - (c*((cos(kappa)*cos(omega) - sin(kappa)*sin(omega)*sin(phi))*(X - X0) - (cos(omega)*sin(kappa) + cos(kappa)*sin(omega)*sin(phi))*(Y - Y0)))/((sin(kappa)*sin(omega) - cos(kappa)*cos(omega)*sin(phi))*(X - X0) + (cos(kappa)*sin(omega) + cos(omega)*sin(kappa)*sin(phi))*(Y - Y0) + cos(omega)*cos(phi)*(Z - Z0))];


syms X X0 Y Y0 Z Z0 f f x y cx cy phi kappa omega k1 k2 k3 p1 p2
r = sqrt((x-cx)^2 + (y-cy)^2);
x2 = - f * (R11(omega,phi,kappa).*(X-X0) + R12(omega,phi,kappa).*(Y-Y0) + R13(omega,phi,kappa).*(Z-Z0)) ./ (R31(omega,phi,kappa).*(X-X0) + R32(omega,phi,kappa).*(Y-Y0) + R33(omega,phi,kappa).*(Z-Z0)) + cx + k1 * r^3 + k2 * r^5 + k3 * r^7 + p1*(r^2 + 2*(x-cx)^2) + 2*p2*(x-cx)*(y-cy);
y2 = - f * (R21(omega,phi,kappa).*(X-X0) + R22(omega,phi,kappa).*(Y-Y0) + R23(omega,phi,kappa).*(Z-Z0)) ./ (R31(omega,phi,kappa).*(X-X0) + R32(omega,phi,kappa).*(Y-Y0) + R33(omega,phi,kappa).*(Z-Z0)) + cy + k1 * r^3 + k2 * r^5 + k3 * r^7 + 2*p1*(x-cx)*(y-cy) + p2*(r^2 + 2*(y-cy)^2);

%syms x_hat y_hat
%x = - f * (R11(omega,phi,kappa).*(X-X0) + R12(omega,phi,kappa).*(Y-Y0) + R13(omega,phi,kappa).*(Z-Z0)) ./ (R31(omega,phi,kappa).*(X-X0) + R32(omega,phi,kappa).*(Y-Y0) + R33(omega,phi,kappa).*(Z-Z0)) + cx - k1 * r^3 + k2 * r^5 + k3 * r^7 + p1*(r^2 + 2*(x-cx)^2) + 2*p2*(x-cx)*(y-cy);
%y = - f * (R21(omega,phi,kappa).*(X-X0) + R22(omega,phi,kappa).*(Y-Y0) + R23(omega,phi,kappa).*(Z-Z0)) ./ (R31(omega,phi,kappa).*(X-X0) + R32(omega,phi,kappa).*(Y-Y0) + R33(omega,phi,kappa).*(Z-Z0)) + cy - k1 * r^3 + k2 * r^5 + k3 * r^7 + 2*p1*(x-cx)*(y-cy) + p2*(r^2 + 2*(y-cy)^2);


